# 6장 프록시

## 프록시 개요

프록시는 클라이언트와 서버 사이에서 HTTP 메시지를 중계하는 **중개자(Intermediary)** 역할을 한다. 웹 프록시 서버는 클라이언트의 입장에서는 서버처럼 동작하고, 서버의 입장에서는 클라이언트처럼 동작한다.

### 프록시의 특징
- HTTP 메시지를 정리하고 전달하는 중개자
- 웹 서버이면서 동시에 웹 클라이언트
- 보안 개선, 성능 향상, 비용 절감 등 다양한 부가 서비스 제공

## 웹 중개자 (Web Intermediaries)

### 개인 및 공유 프록시 (Private and Shared Proxies)

**개인 프록시(Private Proxy)**
- 하나의 클라이언트만을 위한 전용 프록시
- 개별 사용자의 요구사항에 맞춘 커스터마이징 가능
- 브라우저 확장 프로그램 형태로 제공되기도 함

**공유 프록시(Shared Proxy)**  
- 여러 클라이언트가 함께 사용하는 프록시
- 사용자가 많을수록 캐시 효율성 향상
- 대부분의 프록시는 공유 프록시

### 프록시 대 게이트웨이 (Proxies vs Gateways)

**프록시**
- 같은 프로토콜을 사용하는 애플리케이션들을 연결
- HTTP 클라이언트와 HTTP 서버 사이에서 HTTP 메시지 중계
- 예: HTTP ↔ HTTP

**게이트웨이**
- 서로 다른 프로토콜을 사용하는 애플리케이션들을 연결
- 프로토콜 변환기 역할
- 예: HTTP ↔ FTP, HTTP ↔ HTTPS, HTTP ↔ POP3

>  실무에서는 프록시와 게이트웨이의 경계가 모호하며, 상용 프록시 서버는 대부분 게이트웨이 기능도 제공한다.

---

## 왜 프록시를 사용하는가?

프록시는 보안 개선, 성능 향상, 비용 절감을 위한 다양한 부가 기능을 제공한다:

### 1. 콘텐츠 필터링
- **어린이 필터**: 성인 콘텐츠 차단
- **필터링 프록시**: 교육 현장에서 특정 사이트 접근 차단
- **악성 콘텐츠 차단**: 바이러스, 피싱 사이트 차단

### 2. 접근 제어
- **문서 접근 제어자**: 웹 서버에 대한 단일 접근 제어 전략 구현
- **권한 기반 접근**: 사용자별 다른 접근 권한 부여
- **중앙 집중식 접근 정책**: 조직 전체의 웹 사용 정책 관리

### 3. 보안 방화벽
- **보안 방화벽**: 신뢰할 수 있는 내부 네트워크와 공용 인터넷 사이 보안 장벽
- **네트워크 침입 탐지**: 의심스러운 트래픽 패턴 감지
- **프로토콜 필터링**: 특정 프로토콜만 허용

### 4. 웹 캐시
- **프록시 캐시**: 인기 있는 문서의 로컬 사본 저장
- **성능 향상**: 네트워크 대역폭 절감, 응답 시간 단축
- **비용 절감**: 네트워크 트래픽 감소로 인한 비용 절감

### 5. 리버스 프록시 (대리 프록시)
- **리버스 프록시/서버 가속기**: 느린 웹 서버 앞에서 성능 개선
- **부하 분산**: 여러 서버로 요청 분산
- **장애 대응**: 장애 서버 감지 및 우회

### 6. 콘텐츠 라우터
- **요청 라우팅**: 인터넷 트래픽 조건과 콘텐츠 종류에 따른 라우팅
- **서비스 구독자 처리**: 사용자별 맞춤 서비스 제공
- **지역 기반 라우팅**: 사용자 위치에 따른 최적 서버 선택

### 7. 트랜스코더
- **콘텐츠 변환**: 본문 포맷 변경 (예: 이미지 압축, 해상도 조정)
- **디바이스 최적화**: 모바일 기기용 콘텐츠 변환
- **언어 번역**: 자동 번역 서비스 제공

### 8. 익명화 프록시
- **신원 정보 제거**: IP 주소, User-Agent 등 개인 식별 정보 제거
- **프라이버시 보호**: 사용자의 웹 사용 기록 보호
- **Referer 헤더 제거**: 이전 방문 사이트 정보 숨김

---

## 프록시는 어디에 위치하는가?

### 프록시 서버 배치

프록시는 네트워크의 어디에든 배치될 수 있으며, 위치에 따라 다른 목적을 수행한다:

**1. 출구(Egress) 프록시**
- **위치**: 로컬 네트워크와 인터넷 사이의 경계
- **목적**: 
  - 내부 네트워크에서 외부로 나가는 트래픽 제어
  - 회사 방화벽의 일부로 작동
  - 악의적인 사이트 차단 및 콘텐츠 필터링
- **예시**: 기업 프록시, 학교 네트워크 프록시

**2. 접근(Access) 프록시**
- **위치**: ISP(인터넷 서비스 제공자) 접근 지점
- **목적**:
  - ISP 고객의 모든 요청을 종합 처리
  - 대역폭 절약을 위한 캐싱
  - 사용자 인증 및 과금
- **예시**: ISP 캐싱 프록시

**3. 리버스 프록시 (대리/Surrogate 프록시)**
- **위치**: 웹 서버들의 바로 앞
- **목적**:
  - 웹 서버 부하 분산
  - 정적 콘텐츠 캐싱으로 서버 부담 감소
  - 서버 보안 강화 (실제 서버 IP 숨김)
- **예시**: CDN(Content Delivery Network), 로드 밸런서

**4. 네트워크 교환(Network Exchange) 프록시**
- **위치**: 인터넷 피어링 교환 지점
- **목적**:
  - 네트워크 간 트래픽 최적화
  - 캐싱을 통한 피어링 비용 절감
  - 트래픽 모니터링 및 분석
- **예시**: IXP(Internet Exchange Point) 프록시

### 프록시 계층 (Proxy Hierarchies)

- 메시지가 최종적으로 원 서버에 도착할 때까지 프록시에서 프록시로 이동
- 프록시 서버들은 '부모(parent)'와 '자식(child)'의 관계를 가짐
- 인바운드 프록시(서버에 가까운 쪽): 부모
- 아웃바운드 프록시(클라이언트에 가까운 쪽): 자식

**프록시 계층 콘텐츠 라우팅**
- 프록시 계층은 콘텐츠 라우팅을 위한 정적이고 동적인 알고리즘을 사용
- 부모 프록시 선택은 상황에 따라 달라질 수 있음

### 어떻게 프락시가 트래픽을 처리하는가

클라이언트 트래픽이 프록시로 가도록 만드는 방법들:

1. **클라이언트 수정**: 클라이언트가 프록시를 사용하도록 설정
2. **네트워크 수정**: 네트워크 인프라를 통해 트래픽을 프록시로 라우팅
3. **DNS 이름공간 수정**: DNS 서버가 프록시의 주소를 반환하도록 설정
4. **웹 서버 수정**: 웹 서버가 클라이언트를 프록시로 리다이렉트

---

## 클라이언트 프록시 설정

브라우저가 프록시를 사용하도록 설정하는 여러 가지 방법이 있다:

### 1. 수동 프록시 설정

**특징**
- 사용자가 브라우저 설정에서 프록시 서버 주소와 포트를 직접 입력
- 가장 단순하지만 유지보수가 어려움
- 프록시 변경 시 모든 클라이언트 수동 업데이트 필요

**설정 예시**
```
프록시 서버: proxy.company.com
포트: 8080
예외 목록: localhost, 127.0.0.1, *.local
```

### 2. 브라우저 기본 프록시 설정

**특징**
- 브라우저 벤더나 배포자가 미리 프록시 설정
- 기업 환경에서 IT 부서가 브라우저 배포 시 설정
- 사용자가 변경할 수 없도록 잠금 가능

### 3. 프록시 자동설정(PAC) 파일

**PAC(Proxy Auto-Configuration) 파일**
- JavaScript로 작성된 프록시 설정 스크립트
- URL 패턴에 따라 동적으로 프록시 선택
- 부하 분산과 장애 대응 가능

**PAC 파일 예시**
```javascript
function FindProxyForURL(url, host) {
    // 로컬 호스트는 직접 연결
    if (isPlainHostName(host) || 
        dnsDomainIs(host, ".local")) {
        return "DIRECT";
    }
    
    // 내부 네트워크는 내부 프록시 사용
    if (isInNet(host, "10.0.0.0", "255.0.0.0")) {
        return "PROXY internal-proxy.company.com:8080";
    }
    
    // 나머지는 외부 프록시 사용
    return "PROXY external-proxy.company.com:8080";
}
```

**PAC 파일 배포 방법**
- 웹 서버에 PAC 파일 호스팅
- 브라우저에 PAC 파일 URL 설정
- MIME 타입: `application/x-ns-proxy-autoconfig`

### 4. WPAD 프록시 발견

**WPAD(Web Proxy Auto-Discovery) 프로토콜**
- PAC 파일 위치를 자동으로 찾는 메커니즘
- 별도 설정 없이 프록시 자동 구성

**WPAD 동작 순서**
1. **DHCP 조회**: DHCP 서버에서 WPAD 옵션(252) 확인
2. **DNS 조회**: 
   - `wpad.example.com` 도메인 조회
   - 도메인 계층을 따라 올라가며 WPAD 서버 검색
3. **PAC 파일 다운로드**: `http://wpad.example.com/wpad.dat`
4. **PAC 파일 실행**: 프록시 설정 적용

**보안 고려사항**
- WPAD는 중간자 공격에 취약할 수 있음
- HTTPS를 통한 PAC 파일 제공 권장
- DNS 하이재킹 방지 필요

---

## 프록시 요청의 까다로운 점들

### 프록시 URI와 서버 URI의 차이

클라이언트가 프록시를 사용할 때와 직접 서버에 연결할 때 요청 형식이 다르다:

**직접 서버 요청 (부분 URI)**
```http
GET /index.html HTTP/1.0
Host: www.example.com
User-Agent: Mozilla/5.0
```

**프록시 요청 (완전한 URI)**  
```http
GET http://www.example.com/index.html HTTP/1.0
Host: www.example.com
User-Agent: Mozilla/5.0
```

**차이점 설명**
- 서버 직접 연결: 경로만 포함 (`/index.html`)
- 프록시 경유: 전체 URL 포함 (`http://www.example.com/index.html`)
- 프록시는 완전한 URI로 목적지 서버를 파악

### 가상 호스팅과 같은 문제

가상 호스팅을 사용하는 서버의 경우:
- 프록시가 부분 URI만 받으면 목적지 서버를 알 수 없음
- Host 헤더를 통해 해결

### 인터셉트 프록시는 부분 URI를 받는다

**인터셉트 프록시(Intercepting Proxy)**
- 클라이언트는 프록시를 사용하고 있다는 것을 알지 못함
- 원래 서버로 보내는 것처럼 부분 URI를 전송
- 프록시는 다른 방법으로 목적지 서버 정보를 얻어야 함

### 프록시는 프록시 요청과 서버 요청을 모두 다룰 수 있다

프록시 서버는 다음을 모두 처리할 수 있어야 한다:
- 완전한 URI를 가진 프록시 요청
- 부분 URI를 가진 서버 요청

### 전송 중 URI 수정

프록시는 요청을 전달하기 전에 URI를 수정할 수 있다:
- 정규화, 표준화
- 악성 URL 차단
- 리다이렉션

### 클라이언트 자동 확장과 호스트 명 분석

브라우저의 자동 확장 기능:
- 사용자가 입력한 호스트 명을 자동으로 확장
- 프록시가 이를 올바르게 처리해야 함

---

## 메시지 추적

### Via 헤더

**Via 헤더의 역할**
- 메시지가 지나는 각 중간 노드(프록시나 게이트웨이)의 정보를 나열
- 메시지 전달 경로 추적
- 메시지 루프 진단
- 프로토콜 능력 파악

**Via 헤더 문법**
```
Via: 1.1 proxy1.example.com, 1.0 proxy2.example.com
```

각 경유지는 네 개의 구성요소를 포함:
- 선택적인 프로토콜 이름
- 필수 프로토콜 버전  
- 필수 노드 이름
- 선택적인 설명 주석

### Server 응답 헤더

**Server 헤더의 역할**
- 원 서버에 의해 사용되는 소프트웨어 정보 제공
- 프록시는 Server 헤더를 수정해서는 안 됨

### TRACE 메서드

**TRACE의 목적**
- 요청 메시지가 프록시 연쇄를 따라가면서 어떻게 수정되는지 관찰
- 프록시 체인 진단 도구

**TRACE 동작**
1. 클라이언트가 TRACE 요청 전송
2. 각 프록시가 Via 헤더에 자신의 정보 추가
3. 목적지 서버가 전체 요청을 응답 본문에 포함하여 반환

### Max-Forwards

**Max-Forwards 헤더**
- 요청이 거쳐갈 수 있는 프록시/게이트웨이 홉의 최대 개수
- TRACE와 OPTIONS 메서드와 함께 사용
- 무한 루프 방지 및 진단 메커니즘 제공

**동작 방식**
- 각 프록시가 값을 1씩 감소
- 0에 도달하면 더 이상 전달하지 않음

---

## 프록시 인증

프록시는 접근 제어 장치로서 동작할 수 있다:

**프록시 인증 메커니즘**
- 사용자가 유효한 접근 권한 자격을 제출해야 함
- 407 Proxy Authentication Required 상태 코드 사용
- Proxy-Authorization 헤더로 자격 증명 제공

**인증 과정**
1. 클라이언트가 프록시에 요청
2. 프록시가 407 응답과 함께 Proxy-Authenticate 헤더 전송
3. 클라이언트가 Proxy-Authorization 헤더와 함께 재요청
4. 인증 성공 시 요청 처리

---

## 프록시 상호운용성

### 지원하지 않는 헤더와 메서드 다루기

**헤더 처리 원칙**
- 프록시는 넘어오는 헤더를 모두 이해하지 못할 수 있음
- 이해할 수 없는 헤더는 반드시 그대로 전달해야 함
- Connection 헤더는 홉별(hop-by-hop) 헤더이므로 제거해야 함

**메서드 처리 원칙**  
- 이해할 수 없는 메서드는 다운스트림 서버로 전달
- 서버가 메서드를 지원하지 않으면 적절한 오류 응답 반환

### OPTIONS: 어떤 기능을 지원하는지 알아보기

**OPTIONS 메서드의 역할**
- 서버나 특정 리소스가 지원하는 기능 확인
- 프록시나 클라이언트가 능력을 파악하는데 사용

**사용 예시**
```http
OPTIONS * HTTP/1.1
Host: www.example.com
```

### Allow 헤더

**Allow 헤더의 역할**
- 요청 URI에 의해 식별되는 자원이 지원하는 메서드들을 열거
- OPTIONS 응답이나 405 Method Not Allowed 응답에서 사용

**예시**
```http  
Allow: GET, HEAD, POST, PUT, DELETE
```
