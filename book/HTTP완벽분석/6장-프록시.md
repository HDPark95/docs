# 6장 프록시

## 웹 중개자 (Web Intermediaries)

### 개인 및 공유 프록시 (Private and Shared Proxies)

프록시 서버는 클라이언트와 서버 사이에서 HTTP 메시지를 정리하는 중개자로 동작한다.

**개인 프록시(Private Proxy)**
- 하나의 클라이언트를 위해 사용되는 프록시
- 개별 클라이언트의 전용 프록시

**공유 프록시(Shared Proxy)**  
- 여러 클라이언트들이 공유하는 프록시
- 더 많은 사용자가 공유할수록 유용한 캐시를 활용할 가능성이 높음

### 프록시 대 게이트웨이 (Proxies vs Gateways)

**프록시**
- 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결
- HTTP 클라이언트와 HTTP 서버 사이에서 동작

**게이트웨이**
- 서로 다른 프로토콜을 사용하는 둘 이상을 연결
- HTTP/FTP 게이트웨이, HTTP/HTTPS 게이트웨이 등

실질적으로 프록시와 게이트웨이의 차이점은 모호한 경우가 많다.

---

## 왜 프록시를 사용하는가?

프록시 서버는 실용적이고 유용한 여러 목적으로 사용된다:

**보안 개선**
- 바이러스나 성인 콘텐츠를 제거하는 필터 역할
- 방화벽 기능 제공

**성능 향상**
- 자주 찾는 문서의 로컬 사본을 캐시에 저장
- 빠른 접근 제공

**비용 절약**
- 네트워크 대역폭을 줄여 비용 절감

**모니터링 및 제어**
- 모든 HTTP 트래픽을 들여다보고 건드릴 수 있음
- 사용 통계 수집 및 분석

---

## 프록시는 어디에 위치하는가?

### 프록시 서버 배치

**출구(Egress) 프록시**
- 로컬 네트워크와 더 큰 인터넷 사이를 오가는 트래픽 제어
- 로컬 네트워크의 출구에 위치

**접근(Access) 프록시**
- 고객으로부터의 모든 요청을 종합적으로 처리
- ISP 접근 지점에 위치

**대리(Surrogate) 프록시**
- 웹 서버들 바로 앞에 위치
- 웹 서버로 향하는 모든 요청을 처리하고 필요할 때만 웹 서버에게 자원을 요청

**네트워크 교환(Network Exchange) 프록시**
- 네트워크 사이의 인터넷 피어링 교환 지점들에 위치

### 프록시 계층 (Proxy Hierarchies)

**계층 구조**
- 메시지가 최종적으로 원 서버에 도착할 때까지 프록시에서 프록시로 이동
- 프록시 서버들은 '부모(parent)'와 '자식(child)'의 관계를 가짐

**계층 용어**
- 인바운드 프록시(서버에 가까운 쪽): 부모
- 아웃바운드 프록시(클라이언트에 가까운 쪽): 자식

**프록시 계층 콘텐츠 라우팅**
- 프록시 계층은 콘텐츠 라우팅을 위한 정적이고 동적인 알고리즘을 사용
- 부모 프록시 선택은 상황에 따라 달라질 수 있음

### 프록시가 트래픽을 가져오는 방법

클라이언트 트래픽이 프록시로 가도록 만드는 방법들:

1. **클라이언트 수정**: 클라이언트가 프록시를 사용하도록 설정
2. **네트워크 수정**: 네트워크 인프라를 통해 트래픽을 프록시로 라우팅
3. **DNS 이름공간 수정**: DNS 서버가 프록시의 주소를 반환하도록 설정
4. **웹 서버 수정**: 웹 서버가 클라이언트를 프록시로 리다이렉트

---

## 클라이언트 프록시 설정

### 수동 프록시 설정

사용자가 직접 프록시를 설정하는 방법:
- 프록시를 사용하겠다고 명시적으로 설정
- 호스트와 포트를 지정하여 HTTP 요청을 보낼 프록시 지정

### 브라우저 기본 프록시 설정

브라우저 벤더나 배포자가 미리 설정:
- 브라우저를 소비자에게 전달하기 전에 프록시를 가리키도록 설정
- ISP나 조직에서 미리 구성된 브라우저 제공

### 프록시 자동설정(PAC) 파일

**PAC(Proxy Auto-Configuration) 파일**
- JavaScript 함수가 포함된 파일
- 클라이언트가 프록시 자동설정 파일을 가져와서 프록시를 동적으로 식별
- 요청 URL에 따라 다른 프록시 서버 지정 가능

### WPAD 프록시 발견

**WPAD(Web Proxy Auto-Discovery)**
- 대부분의 브라우저가 제공하는 프로토콜
- 브라우저가 근처의 프록시를 찾기 위해 여러 발견 메커니즘 사용
- DHCP나 DNS를 통해 PAC 파일 위치를 자동으로 찾음

---

## 프록시 요청의 까다로운 점들

### 프록시 URI와 서버 URI의 차이

**서버 요청**
```http
GET /index.html HTTP/1.0
```

**프록시 요청**  
```http
GET http://www.marys-antiques.com/index.html HTTP/1.0
```

프록시 요청에서는 완전한 URI가 필요하다.

### 가상 호스팅과 같은 문제

가상 호스팅을 사용하는 서버의 경우:
- 프록시가 부분 URI만 받으면 목적지 서버를 알 수 없음
- Host 헤더를 통해 해결

### 인터셉트 프록시는 부분 URI를 받는다

**인터셉트 프록시(Intercepting Proxy)**
- 클라이언트는 프록시를 사용하고 있다는 것을 알지 못함
- 원래 서버로 보내는 것처럼 부분 URI를 전송
- 프록시는 다른 방법으로 목적지 서버 정보를 얻어야 함

### 프록시는 프록시 요청과 서버 요청을 모두 다룰 수 있다

프록시 서버는 다음을 모두 처리할 수 있어야 한다:
- 완전한 URI를 가진 프록시 요청
- 부분 URI를 가진 서버 요청

### 전송 중 URI 수정

프록시는 요청을 전달하기 전에 URI를 수정할 수 있다:
- 정규화, 표준화
- 악성 URL 차단
- 리다이렉션

### 클라이언트 자동 확장과 호스트 명 분석

브라우저의 자동 확장 기능:
- 사용자가 입력한 호스트 명을 자동으로 확장
- 프록시가 이를 올바르게 처리해야 함

---

## 메시지 추적

### Via 헤더

**Via 헤더의 역할**
- 메시지가 지나는 각 중간 노드(프록시나 게이트웨이)의 정보를 나열
- 메시지 전달 경로 추적
- 메시지 루프 진단
- 프로토콜 능력 파악

**Via 헤더 문법**
```
Via: 1.1 proxy1.example.com, 1.0 proxy2.example.com
```

각 경유지는 네 개의 구성요소를 포함:
- 선택적인 프로토콜 이름
- 필수 프로토콜 버전  
- 필수 노드 이름
- 선택적인 설명 주석

### Server 응답 헤더

**Server 헤더의 역할**
- 원 서버에 의해 사용되는 소프트웨어 정보 제공
- 프록시는 Server 헤더를 수정해서는 안 됨

### TRACE 메서드

**TRACE의 목적**
- 요청 메시지가 프록시 연쇄를 따라가면서 어떻게 수정되는지 관찰
- 프록시 체인 진단 도구

**TRACE 동작**
1. 클라이언트가 TRACE 요청 전송
2. 각 프록시가 Via 헤더에 자신의 정보 추가
3. 목적지 서버가 전체 요청을 응답 본문에 포함하여 반환

### Max-Forwards

**Max-Forwards 헤더**
- 요청이 거쳐갈 수 있는 프록시/게이트웨이 홉의 최대 개수
- TRACE와 OPTIONS 메서드와 함께 사용
- 무한 루프 방지 및 진단 메커니즘 제공

**동작 방식**
- 각 프록시가 값을 1씩 감소
- 0에 도달하면 더 이상 전달하지 않음

---

## 프록시 인증

프록시는 접근 제어 장치로서 동작할 수 있다:

**프록시 인증 메커니즘**
- 사용자가 유효한 접근 권한 자격을 제출해야 함
- 407 Proxy Authentication Required 상태 코드 사용
- Proxy-Authorization 헤더로 자격 증명 제공

**인증 과정**
1. 클라이언트가 프록시에 요청
2. 프록시가 407 응답과 함께 Proxy-Authenticate 헤더 전송
3. 클라이언트가 Proxy-Authorization 헤더와 함께 재요청
4. 인증 성공 시 요청 처리

---

## 프록시 상호운용성

### 지원하지 않는 헤더와 메서드 다루기

**헤더 처리 원칙**
- 프록시는 넘어오는 헤더를 모두 이해하지 못할 수 있음
- 이해할 수 없는 헤더는 반드시 그대로 전달해야 함
- Connection 헤더는 홉별(hop-by-hop) 헤더이므로 제거해야 함

**메서드 처리 원칙**  
- 이해할 수 없는 메서드는 다운스트림 서버로 전달
- 서버가 메서드를 지원하지 않으면 적절한 오류 응답 반환

### OPTIONS: 어떤 기능을 지원하는지 알아보기

**OPTIONS 메서드의 역할**
- 서버나 특정 리소스가 지원하는 기능 확인
- 프록시나 클라이언트가 능력을 파악하는데 사용

**사용 예시**
```http
OPTIONS * HTTP/1.1
Host: www.example.com
```

### Allow 헤더

**Allow 헤더의 역할**
- 요청 URI에 의해 식별되는 자원이 지원하는 메서드들을 열거
- OPTIONS 응답이나 405 Method Not Allowed 응답에서 사용

**예시**
```http  
Allow: GET, HEAD, POST, PUT, DELETE
```