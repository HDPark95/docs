# 캐시를 활용한 성능 최적화

## 조회 API 성능 최적화를 위한 캐싱 전략

캐시를 활용해 조회 API의 성능을 최적화하면 시스템의 응답 시간을 크게 향상시키고 데이터베이스 부하를 줄일 수 있음. 이런 성능 최적화를 위한 주요 캐싱 전략들을 살펴보자.

### 1. 읽기 중심 캐싱 전략

읽기 작업이 많은 API에서는 다음과 같은 캐싱 전략이 효과적임:

- **Look-Aside (Lazy Loading) 패턴**
  ```
  1. 클라이언트가 데이터 요청
  2. 애플리케이션이 먼저 캐시 확인
  3. 캐시에 데이터가 있으면 반환 (캐시 히트)
  4. 캐시에 데이터가 없으면 DB에서 조회 (캐시 미스)
  5. DB에서 조회한 데이터를 캐시에 저장하고 클라이언트에 반환
  ```
  
- **캐시 키 설계**
  - **효율적인 캐시 키 설계**는 성능에 큰 영향을 미침
  - 예시로 `user:{userId}:profile`, `product:{productId}:details` 같은 형태를 활용함
  - **복합 키**를 사용하면 `search:category:{categoryId}:page:{pageNum}` 같이 다양한 조회 패턴을 지원할 수 있음

### 2. 데이터 일관성 관리

캐시와 원본 데이터 간의 일관성을 유지하는 방법들을 살펴보면:

- **TTL(Time-To-Live) 설정**
  - 데이터 변경 빈도에 따라 적절한 TTL을 설정해야 함
  - **자주 변경되는 데이터**는 짧은 TTL을 적용하는 것이 좋음
  - **거의 변경되지 않는 데이터**는 긴 TTL이나 영구 캐싱을 고려할 수 있음

- **Write-Through 패턴**
  - 데이터 변경 시 DB와 캐시를 동시에 업데이트하는 방식임
  - 일관성은 높지만 쓰기 지연 시간이 증가하는 단점이 있음

- **Write-Behind 패턴**
  - 캐시를 먼저 업데이트하고 비동기적으로 DB를 업데이트하는 방식임
  - 쓰기 성능은 향상되지만 일관성 보장이 어려운 특징이 있음

## 문제 상황

### 1. 캐시 스템피드 현상(Cache Stampede)

**문제 상황:**
- 캐시가 만료되거나 비어있을 때 **다수의 요청이 동시에 DB에 접근**하는 현상이 발생함
- 이로 인해 DB에 갑작스러운 부하가 집중되어 성능 저하나 장애가 발생할 수 있음

**해결 방안:**
- **세마포어 잠금 메커니즘**: 첫 번째 요청만 DB에 접근하고 나머지는 대기하도록 구현함
- **확률적 조기 만료(Probabilistic early expiration)**: 만료 시간 근처에서 확률적으로 캐시를 갱신하는 전략을 사용함
- **백그라운드 갱신(Background refresh)**: 백그라운드 작업으로 캐시 데이터를 미리 갱신해 문제를 예방함

### 2. 캐시 일관성 문제

**문제 상황:**
- 원본 데이터와 캐시 데이터 간의 **불일치가 발생**하는 경우가 많음
- 특히 **분산 시스템**에서는 이 문제가 더욱 복잡해지는 특징이 있음

**해결 방안:**
- **이벤트 기반 캐시 무효화**: 데이터 변경 시 이벤트를 발행하여 캐시를 업데이트하는 방식을 활용함
- **버전 관리**: 데이터에 버전 정보를 추가해 최신 상태를 확인할 수 있게 함
- **캐시 항목 메타데이터**: 마지막 업데이트 시간 등의 메타데이터를 활용해 일관성을 유지함

### 3. 콜드 스타트 문제

**문제:**
- 시스템 재시작 또는 캐시 클리어 후 캐시가 비어있는 상태에서 성능 저하
- 초기 사용자 경험 악화

**해결 방안:**
- **캐시 워밍**: 시스템 시작 시 주요 데이터를 미리 캐시에 로드
- **점진적 캐시 빌드**: 우선순위가 높은 데이터부터 순차적으로 캐시 구축
- **백업 및 복원**: 캐시 상태를 주기적으로 백업하고 필요시 복원

## 캐시 워밍(Cache Warming) 개념

캐시 워밍은 캐시가 비어있는 상태(콜드 캐시)에서 발생하는 성능 저하를 방지하기 위해, 실제 요청이 들어오기 전에 미리 캐시를 데이터로 채우는 기법입니다.

### 캐시 워밍의 중요성

- **초기 응답 시간 개선**: 시스템 시작 직후 사용자 경험 향상
- **부하 분산**: 피크 시간대 이전에 캐시를 준비하여 DB 부하 분산
- **예측 가능한 성능**: 캐시 미스로 인한 성능 변동성 감소

### 캐시 워밍 구현 방법

1. **시작 시 워밍**
   - 애플리케이션 시작 시 자동으로 주요 데이터 캐싱
   - 시작 프로세스의 일부로 워밍 스크립트 실행

2. **주기적 워밍**
   - 스케줄러를 사용하여 정기적으로 캐시 갱신
   - 특히 TTL 기반 캐시에서 만료 전에 미리 갱신

3. **점진적 워밍**
   - 시스템에 부담을 주지 않도록 점진적으로 캐시 구축
   - 백그라운드 작업으로 천천히 캐시 채우기

